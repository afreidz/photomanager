---
import Layout from '@/layouts/Layout.astro';
import { actions } from 'astro:actions';
import { UserManagement } from '@/components/UserManagement';

// This page is protected by middleware
const currentUser = Astro.locals.user;

// Check if user is admin using action (optional, only for invitations)
let isCurrentUserAdmin = false;
let activeInvitations: any[] = [];
try {
  const { data: adminData } = await Astro.callAction(actions.users.isCurrentUserAdmin, {});
  isCurrentUserAdmin = !!adminData?.isAdmin;
  if (isCurrentUserAdmin) {
    // Fetch all active invitations using action
    const { data: invitationsData, error: invitationsError } =
      await Astro.callAction(actions.invitations.list, {});
    if (invitationsError) {
      console.error(invitationsError);
      throw new Error('Failed to fetch invitations');
    }
    // Filter to only show active invitations
    activeInvitations = invitationsData.invitations.filter(
      (invite) => !invite.isUsed
    );
  }
} catch {}

// Fetch all registered users using action
const { data: usersData, error: usersError } = await Astro.callAction(
  actions.users.list,
  {}
);

if (usersError) {
  console.error(usersError);
  throw new Error('Failed to fetch users');
}

const allUsers = usersData.users;
---
<Layout title="User Management - Photography CMS" currentPath="/users">
  <UserManagement
    users={allUsers}
    invitations={activeInvitations}
    currentUserId={currentUser?.id || ''}
    isCurrentUserAdmin={isCurrentUserAdmin}
    client:load
  />
</Layout>
